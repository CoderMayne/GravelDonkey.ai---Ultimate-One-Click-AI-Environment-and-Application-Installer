# Dockerfile for AI environment with GPU support
# Generated by AI Environment Installer
FROM {{ docker_base_image }}

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    python3-pip \
    wget \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# --- Install Core Python ML Libraries ---
RUN pip install --no-cache-dir {{ torch_package }}
{% if attention_package and attention_package != "None" %}
RUN pip install --no-cache-dir {{ attention_package }}
{% endif %}
RUN pip install --no-cache-dir transformers accelerate bitsandbytes sentencepiece

# --- Application Environment Variables ---
{% for app in selected_apps %}
ENV {{ app.env_var_name }}=/opt/{{ app.folder_name }}
{% endfor %}

# Add custom environment variables from user input
{% if custom_env_vars %}
{% for line in custom_env_vars.split('\n') %}
{% if line.strip() %}
ENV {{ line.strip() }}
{% endif %}
{% endfor %}
{% endif %}

# --- Install Selected Applications ---
WORKDIR /opt

{% for app in selected_apps %}

# --- Installing {{ app.name }} ---
RUN git clone --depth 1 {{ app.repo }} {{ app.folder_name }}
WORKDIR /opt/{{ app.folder_name }}
{% if app.pip_dependencies %}
{% set first_dep = app.pip_dependencies[0] %}
{% if first_dep.startswith("-r ") %}
RUN wget -qO requirements.txt {{ app.repo | replace(".git", "") }}/raw/branch/main/{{ first_dep | replace("-r ", "") }} && \
    pip install --no-cache-dir -r requirements.txt
{% else %}
RUN pip install --no-cache-dir {{ app.pip_dependencies | join(' ') }}
{% endif %}
{% endif %}
{% if app.post_install_commands %}
{% for command in app.post_install_commands %}
RUN {{ command }}
{% endfor %}
{% endif %}
{% endfor %}

# Add custom RUN commands from user input
{% if custom_run_commands %}
{% for line in custom_run_commands.split('\n') %}
{% if line.strip() %}
RUN {{ line.strip() }}
{% endif %}
{% endfor %}
{% endif %}

# --- Final Setup ---
WORKDIR /

COPY start.sh /usr/local/bin/start.sh
RUN chmod +x /usr/local/bin/start.sh
CMD ["/usr/local/bin/start.sh"]
