# Dockerfile for AI environment with GPU support
# Generated by AI Environment Installer
FROM nvidia/cuda:12.6.2-cudnn-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    python3-pip \
    wget \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# --- Install Core Python ML Libraries ---
RUN pip install --no-cache-dir torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0 --index-url https://download.pytorch.org/whl/cu126
RUN pip install --no-cache-dir xformers==0.0.27.post2
RUN pip install --no-cache-dir transformers accelerate bitsandbytes sentencepiece

# --- Application Environment Variables ---
ENV COMFYUI_PATH=/opt/comfyui
ENV HUGGING_FACE_TRANSFORMERS_PATH=/opt/hugging-face-transformers

# Add custom environment variables from user input

# --- Install Selected Applications ---
WORKDIR /opt


# --- Installing ComfyUI ---
RUN git clone --depth 1 https://github.com/comfyanonymous/ComfyUI.git comfyui
WORKDIR /opt/comfyui
RUN wget -qO requirements.txt https://github.com/comfyanonymous/ComfyUI/raw/branch/main/requirements.txt && \
    pip install --no-cache-dir -r requirements.txt

# --- Installing Hugging Face Transformers ---
RUN git clone --depth 1 https://github.com/huggingface/transformers.git hugging-face-transformers
WORKDIR /opt/hugging-face-transformers
RUN pip install --no-cache-dir transformers[torch]

# Add custom RUN commands from user input
RUN pip install --no-cache-dir triton==3.0.0 pandas==2.2.0 numpy==1.26.0 transformers==4.40.0 nltk==3.8.1 spacy==3.8.0 gensim==4.3.2 xgboost==2.0.3

# --- Final Setup ---
WORKDIR /

COPY start.sh /usr/local/bin/start.sh
RUN chmod +x /usr/local/bin/start.sh
CMD ["/usr/local/bin/start.sh"]